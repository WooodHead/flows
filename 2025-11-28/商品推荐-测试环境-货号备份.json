{
  "code": 200,
  "success": true,
  "message": "SUCCESS",
  "data": {
      "applicationType": "AI",
      "color": "#ADE9CE",
      "config": {
          "edges": [
              {
                  "id": "cfe9ae4b-86de-47fa-bfd8-6f551a571e5d-4cb383a7-36ef-4023-9e6c-4e81bee014a7",
                  "type": "insert",
                  "style": {
                      "stroke": "#C0C3D1",
                      "strokeWidth": 2,
                      "strokeLinecap": "round",
                      "strokeLinejoin": "round"
                  },
                  "source": "cfe9ae4b-86de-47fa-bfd8-6f551a571e5d",
                  "target": "4cb383a7-36ef-4023-9e6c-4e81bee014a7",
                  "interactionWidth": 80
              },
              {
                  "id": "c789c979-2ed3-43c9-94b4-2aee5e324230-cfe9ae4b-86de-47fa-bfd8-6f551a571e5d",
                  "type": "insert",
                  "style": {
                      "stroke": "#C0C3D1",
                      "strokeWidth": 2,
                      "strokeLinecap": "round",
                      "strokeLinejoin": "round"
                  },
                  "source": "c789c979-2ed3-43c9-94b4-2aee5e324230",
                  "target": "cfe9ae4b-86de-47fa-bfd8-6f551a571e5d",
                  "interactionWidth": 80
              },
              {
                  "id": "d4c6dc28-e453-4e3c-be91-7181381d49a4-03927ffc-fc24-49b7-a1c6-67cf887e73a1",
                  "type": "insert",
                  "style": {
                      "stroke": "#C0C3D1",
                      "strokeWidth": 2,
                      "strokeLinecap": "round",
                      "strokeLinejoin": "round"
                  },
                  "source": "d4c6dc28-e453-4e3c-be91-7181381d49a4",
                  "target": "03927ffc-fc24-49b7-a1c6-67cf887e73a1",
                  "interactionWidth": 80
              },
              {
                  "id": "7fdfdad3-de32-4ba5-a3d1-49c151082780-d4c6dc28-e453-4e3c-be91-7181381d49a4",
                  "type": "insert",
                  "style": {
                      "stroke": "#C0C3D1",
                      "strokeWidth": 2,
                      "strokeLinecap": "round",
                      "strokeLinejoin": "round"
                  },
                  "source": "7fdfdad3-de32-4ba5-a3d1-49c151082780",
                  "target": "d4c6dc28-e453-4e3c-be91-7181381d49a4",
                  "interactionWidth": 80
              },
              {
                  "id": "03927ffc-fc24-49b7-a1c6-67cf887e73a1-5ec94526-e3a7-48b5-a6ad-d22882b4a6be",
                  "type": "insert",
                  "style": {
                      "stroke": "#C0C3D1",
                      "strokeWidth": 2,
                      "strokeLinecap": "round",
                      "strokeLinejoin": "round"
                  },
                  "source": "03927ffc-fc24-49b7-a1c6-67cf887e73a1",
                  "target": "5ec94526-e3a7-48b5-a6ad-d22882b4a6be",
                  "interactionWidth": 80
              },
              {
                  "id": "660a1d0d-6940-4463-9791-0e5f89b7a96a-c789c979-2ed3-43c9-94b4-2aee5e324230",
                  "type": "insert",
                  "style": {
                      "stroke": "#C0C3D1",
                      "strokeWidth": 2,
                      "strokeLinecap": "round",
                      "strokeLinejoin": "round"
                  },
                  "source": "660a1d0d-6940-4463-9791-0e5f89b7a96a",
                  "target": "c789c979-2ed3-43c9-94b4-2aee5e324230",
                  "interactionWidth": 80
              },
              {
                  "id": "5ec94526-e3a7-48b5-a6ad-d22882b4a6be-660a1d0d-6940-4463-9791-0e5f89b7a96a",
                  "type": "insert",
                  "style": {
                      "stroke": "#C0C3D1",
                      "strokeWidth": 2,
                      "strokeLinecap": "round",
                      "strokeLinejoin": "round"
                  },
                  "source": "5ec94526-e3a7-48b5-a6ad-d22882b4a6be",
                  "target": "660a1d0d-6940-4463-9791-0e5f89b7a96a",
                  "interactionWidth": 80
              }
          ],
          "nodes": [
              {
                  "id": "7fdfdad3-de32-4ba5-a3d1-49c151082780",
                  "data": {
                      "name": "start",
                      "type": "form",
                      "inputs": {},
                      "isEnable": true,
                      "relation": null,
                      "actionType": "TRIGGER",
                      "conditions": [],
                      "formConfig": [
                          {
                              "type": "json",
                              "label": "èŠå¤©è®°å½•",
                              "required": true,
                              "placeholder": "è¯·è¾“å…¥",
                              "variableName": "dialogue",
                              "cascadeFields": [],
                              "isCascadeField": false
                          },
                          {
                              "type": "input",
                              "label": "æœ€æ–°æ¶ˆæ¯",
                              "placeholder": "",
                              "variableName": "message",
                              "cascadeFields": [],
                              "isCascadeField": false
                          },
                          {
                              "type": "input",
                              "label": "äº‹ä»¶äºŒçº§",
                              "placeholder": "",
                              "variableName": "event_two",
                              "cascadeFields": [],
                              "isCascadeField": false
                          },
                          {
                              "type": "input",
                              "label": "åº—é“ºåç§°",
                              "placeholder": "",
                              "variableName": "shop_id",
                              "cascadeFields": [],
                              "isCascadeField": false
                          },
                          {
                              "type": "input",
                              "label": "å¹³å°åç§°",
                              "placeholder": "",
                              "variableName": "platform",
                              "cascadeFields": [],
                              "isCascadeField": false
                          },
                          {
                              "type": "json",
                              "label": "è‡ªå®šä¹‰å‚æ•°",
                              "placeholder": "",
                              "defaultValue": {},
                              "variableName": "customer_config",
                              "cascadeFields": [],
                              "isCascadeField": false
                          },
                          {
                              "type": "json",
                              "label": "æ•°æ®åº“é…ç½®",
                              "placeholder": "",
                              "defaultValue": "",
                              "variableName": "database_config",
                              "cascadeFields": [],
                              "isCascadeField": false
                          },
                          {
                              "type": "json",
                              "label": "çŸ¥è¯†åº“é…ç½®",
                              "placeholder": "",
                              "defaultValue": "",
                              "variableName": "knowledge_base_config",
                              "cascadeFields": [],
                              "isCascadeField": false
                          },
                          {
                              "type": "input",
                              "label": "é‰´æƒä¿¡æ¯",
                              "placeholder": "",
                              "defaultValue": "{}",
                              "variableName": "auth",
                              "cascadeFields": [],
                              "isCascadeField": false
                          }
                      ],
                      "packageName": "",
                      "sortCopyIndex": -1
                  },
                  "name": "start",
                  "type": "START",
                  "layout": {
                      "width": 420,
                      "height": 1068,
                      "position": {
                          "x": 0,
                          "y": 0
                      }
                  },
                  "isEnable": true,
                  "relation": null,
                  "actionType": "TRIGGER"
              },
              {
                  "id": "03927ffc-fc24-49b7-a1c6-67cf887e73a1",
                  "data": {
                      "name": "match",
                      "type": null,
                      "inputs": {
                          "model": "grok-4-fast-non-reasoning",
                          "top_p": 0.6,
                          "plugin": {
                              "json_mode": true
                          },
                          "stream": true,
                          "channel": "Xai",
                          "messages": [
                              {
                                  "role": "user",
                                  "content": "<user>\n  <context>\n    conversation_history:\n      content: \"{{dialogue}}\"\n      description: \"å¯¹è¯å†å²è®°å½•\"\n\n    user_input:\n      content: \"{{message}}\"\n      description: \"é¡¾å®¢å½“å‰è¾“å…¥\"\n  </context>\n\n  <instruction>\n    task_description:\n      - \"è¯·æ ¹æ®é¡¾å®¢è¾“å…¥å’Œå¯¹è¯è®°å½•,ä»type_listä¸­é€‰æ‹©æœ€åŒ¹é…çš„å•†å“å“ç±»\"\n  </instruction>\n</user>"
                              }
                          ],
                          "promptType": "raw",
                          "temperature": 0.3,
                          "context_type": "messageList",
                          "modelSetting": {
                              "model": "grok-4-fast-non-reasoning",
                              "top_p": 0.6,
                              "channel": "Xai",
                              "outputType": "json",
                              "temperature": 0.3,
                              "frequency_penalty": 0,
                              "is_variable_selected": false
                          },
                          "is_show_think": true,
                          "system_content": "<system>\n  <role>\n    agent_info:\n      identity: \"å•†å“å“ç±»åˆ¤æ–­ä¸“å®¶\"\n      task: \"åŸºäºé¡¾å®¢è¾“å…¥å’Œå¯¹è¯ä¸Šä¸‹æ–‡,ä»å“ç±»åˆ—è¡¨ä¸­é€‰æ‹©æœ€åŒ¹é…çš„å•†å“å“ç±»\"\n  </role>\n\n  <context>\n    type_list:\n      content: \"{{type.data}}\"\n      description: \"å¯é€‰çš„å•†å“å“ç±»åˆ—è¡¨\"\n  </context>\n\n  <output>\n    response_format:\n      format: \"JSON\"\n      schema:\n        type: \"object\"\n        required: [\"category\"]\n        properties:\n          category:\n            type: \"string\"\n            description: \"åŒ¹é…çš„å•†å“å“ç±»,å¿…é¡»ä»type_listä¸­é€‰æ‹©\"\n  </output>\n\n  <priority>\n    selection_priority:\n      - \"ä¼˜å…ˆåŒ¹é…é¡¾å®¢æ˜ç¡®æåˆ°çš„å•†å“åç§°æˆ–ç‰¹å¾\"\n      - \"å…¶æ¬¡å‚è€ƒå¯¹è¯ä¸Šä¸‹æ–‡ä¸­çš„å•†å“ä¿¡æ¯\"\n      - \"æ— æ³•ç¡®å®šæ—¶é€‰æ‹©æœ€é€šç”¨æˆ–æœ€å¯èƒ½çš„å“ç±»\"\n  </priority>\n\n  <constraints>\n    selection_rules:\n      must_from_list:\n        - \"categoryå€¼å¿…é¡»æ˜¯type_listä¸­çš„æŸä¸€é¡¹\"\n        - \"ä¸¥ç¦è¾“å‡ºåˆ—è¡¨å¤–çš„å“ç±»åç§°\"\n\n      fallback_strategy:\n        - \"å½“å®Œå…¨æ— æ³•åˆ¤æ–­æ—¶,ä»type_listä¸­é€‰æ‹©æœ€é€šç”¨çš„å“ç±»\"\n        - \"å¦‚æœtype_listæœ‰'å…¶ä»–'æˆ–ç±»ä¼¼å…œåº•å“ç±»,ä¼˜å…ˆé€‰æ‹©\"\n        - \"è‹¥æ— å…œåº•å“ç±»,é€‰æ‹©åˆ—è¡¨ä¸­ç¬¬ä¸€ä¸ªå“ç±»\"\n\n    matching_strategy:\n      - \"æå–é¡¾å®¢è¾“å…¥ä¸­çš„å…³é”®å•†å“è¯æ±‡\"\n      - \"å¯¹æ¯”type_listä¸­æ¯ä¸ªå“ç±»çš„è¯­ä¹‰ç›¸å…³æ€§\"\n      - \"é€‰æ‹©ç›¸å…³æ€§æœ€é«˜çš„å“ç±»\"\n  </constraints>\n</system>",
                          "frequency_penalty": 0,
                          "is_show_think_var": null
                      },
                      "isEnable": true,
                      "relation": null,
                      "actionType": "INTEGRATION",
                      "conditions": [],
                      "formConfig": null,
                      "packageName": "integration.llm.LLMAction",
                      "sortCopyIndex": -1
                  },
                  "name": "match",
                  "type": "LLM",
                  "layout": {
                      "width": 420,
                      "height": 1061,
                      "position": {
                          "x": 1088,
                          "y": 0
                      }
                  },
                  "isEnable": true,
                  "relation": null,
                  "actionType": "INTEGRATION"
              },
              {
                  "id": "4cb383a7-36ef-4023-9e6c-4e81bee014a7",
                  "data": {
                      "name": "output",
                      "type": null,
                      "inputs": {},
                      "isEnable": true,
                      "relation": null,
                      "actionType": "END",
                      "conditions": [],
                      "formConfig": null,
                      "packageName": "",
                      "sortCopyIndex": -1
                  },
                  "name": "output",
                  "type": "END",
                  "layout": {
                      "width": 420,
                      "height": 98,
                      "position": {
                          "x": 3808,
                          "y": 0
                      }
                  },
                  "isEnable": true,
                  "relation": null,
                  "actionType": "END"
              },
              {
                  "id": "cfe9ae4b-86de-47fa-bfd8-6f551a571e5d",
                  "data": {
                      "name": "answer",
                      "type": null,
                      "inputs": {
                          "code": "from betteryeah import BetterYeah, Model\nbetter_yeah = BetterYeah()\n\nasync def main():\n    answer = summary.get('answer')\n    thinking = summary.get('thinking')\n\n    return {\n        'messages': [answer],\n        'thinking': thinking,\n        \"flow_name\": \"å•†å“æ¨è\",\n        \"flow_type\": \"RECOMMEND\",\n        \"debug_message\":f\"å•†å“æ¨è:\\n\\tæ€è€ƒè¿‡ç¨‹: {thinking}\\n\\tå›ç­”: {answer}\"\n    }\n",
                          "desc": "",
                          "version": 1,
                          "language": "python"
                      },
                      "isEnable": true,
                      "relation": null,
                      "actionType": "CODE",
                      "conditions": [],
                      "formConfig": null,
                      "packageName": "",
                      "sortCopyIndex": -1
                  },
                  "name": "answer",
                  "type": "CODE",
                  "layout": {
                      "width": 420,
                      "height": 435,
                      "position": {
                          "x": 3264,
                          "y": 0
                      }
                  },
                  "isEnable": true,
                  "relation": null,
                  "actionType": "CODE"
              },
              {
                  "id": "c789c979-2ed3-43c9-94b4-2aee5e324230",
                  "data": {
                      "name": "summary",
                      "type": null,
                      "inputs": {
                          "model": "grok-4-fast-non-reasoning",
                          "top_p": 0.6,
                          "plugin": {
                              "json_mode": true
                          },
                          "stream": true,
                          "channel": "Xai",
                          "messages": [
                              {
                                  "role": "user",
                                  "content": "<user>\n  <context>\n    current_message:\n      content: \"{{message}}\"\n      description: \"é¡¾å®¢æœ€æ–°æ¶ˆæ¯\"\n\n    dialogue_history:\n      content: \"{{dialogue}}\"\n      description: \"å†å²å¯¹è¯è®°å½•\"\n  </context>\n\n  <instruction>\n    task_description:\n      - \"ç†è§£é¡¾å®¢éœ€æ±‚,ä»productä¸­æ¨èåˆé€‚å•†å“\"\n      - \"productä¸­æœ‰é“¾æ¥æ—¶é™„å¸¦,æ— é“¾æ¥æ—¶ä¸æ·»åŠ \"\n      - \"éµå¾ªä¸ªæ€§åŒ–æ¨èæŒ‡ä»¤(è‹¥æœ‰)\"\n  </instruction>\n</user>"
                              }
                          ],
                          "promptType": "raw",
                          "temperature": 0.3,
                          "context_type": "messageList",
                          "modelSetting": {
                              "model": "grok-4-fast-non-reasoning",
                              "top_p": 0.6,
                              "channel": "Xai",
                              "outputType": "json",
                              "temperature": 0.3,
                              "presence_penalty": 1.5,
                              "frequency_penalty": 0,
                              "is_variable_selected": false
                          },
                          "is_show_think": true,
                          "system_content": "<system>\n  <role>\n    agent_info:\n      identity: \"{{shop_id}}å®¢æœ\"\n      task: \"ä»£æ›¿äººå·¥å®¢æœ,ä»¥çœŸäººè§†è§’ä¸ºé¡¾å®¢æä¾›å•†å“æ¨èå’Œç²¾å‡†é—®ç­”\"\n      behavioral_rules:\n        è¯­æ°”è¦æ±‚:\n          - \"è‡ªç„¶å£è¯­åŒ–è¡¨è¾¾,å¦‚'äº²'ã€'æ‚¨'ã€'è¿™è¾¹'\"\n          - \"ä¿æŒçœŸäººå®¢æœçš„äº²åˆ‡å‹å¥½è¯­æ°”\"\n        é•¿åº¦é™åˆ¶:\n          - \"ä¸è¶…è¿‡50å­—(ä¸åŒ…æ‹¬å•†å“URL)\"\n        æ ¼å¼è¦æ±‚:\n          - \"ä¸¥æ ¼ç¦æ­¢åˆ—è¡¨æ ¼å¼(-ã€*ã€æ•°å­—ç­‰)å’Œmarkdownè¯­æ³•\"\n          - \"productä¸­æœ‰å•†å“é“¾æ¥æ—¶é™„å¸¦,æ— é“¾æ¥æ—¶ä¸æ·»åŠ \"\n        èº«ä»½ä¿æŠ¤:\n          - \"ç¦æ­¢ä¸»åŠ¨æåŠAIã€æœºå™¨äººã€æ™ºèƒ½å®¢æœç­‰æŠ€æœ¯è¯æ±‡\"\n          - \"ä½¿ç”¨ç¬¬ä¸€äººç§°è§†è§’('æˆ‘'ã€'è¿™è¾¹'),é¿å…ç¬¬ä¸‰äººç§°('å®¢æœ')\"\n  </role>\n\n  <context>\n    product:\n      content: \"{{product}}\"\n      description: \"å•†å“å‚æ•°ä¿¡æ¯å’ŒSKUä¿¡æ¯\"\n\n    support_strategy:\n      content: \"{{behavior}}\"\n      description: \"è¾…åŠ©ç­–ç•¥,æ¨èè¯æœ¯å’ŒæŠ€å·§å‚è€ƒ\"\n\n    customization:\n      content: \"{{customer_config.recommend.flow_instruction}}\"\n      description: \"åº—é“ºä¸ªæ€§åŒ–æ¨èæŒ‡ä»¤\"\n  </context>\n\n  <output>\n    response_format:\n      format: \"JSON\"\n      schema:\n        type: \"object\"\n        required: [\"thinking\", \"answer\"]\n        properties:\n          thinking:\n            type: \"string\"\n            description: \"å®Œæ•´æ€è€ƒè¿‡ç¨‹\"\n          answer:\n            type: \"string\"\n            description: \"å®¢æœå›å¤å†…å®¹\"\n  </output>\n\n  <priority>\n    response_focus:\n      - \"è‡ªå®šä¹‰æŒ‡ä»¤ä¼˜å…ˆçº§æœ€é«˜: ä¸ªæ€§åŒ–æ¨èæŒ‡ä»¤ > å…¶ä»–è§„åˆ™\"\n      - \"ä¿¡æ¯æœ‰æ•ˆæ€§: æ¨èå¿…é¡»åŸºäºproductä¸­çš„å®é™…å•†å“\"\n      - \"æ•°æ®ä¸¥æ ¼æ€§: æ‰€æœ‰ä¿¡æ¯ä¸¥æ ¼æ¥è‡ªè¾“å…¥æ•°æ®,ä¸¥ç¦æ ¹æ®å¸¸è¯†è¡¥å……\"\n      - \"è¯­æ°”å‹å¥½åº¦: ä¿æŒçœŸäººå®¢æœçš„è‡ªç„¶äº²åˆ‡è¯­æ°”\"\n  </priority>\n\n  <constraints>\n    core_rules:\n      - \"å›ç­”å‰æ€è€ƒ: æ¨èçš„å•†å“æ˜¯å¦ç¬¦åˆé¡¾å®¢éœ€æ±‚?\"\n      - \"åªæ¨èproductä¸­å­˜åœ¨çš„å•†å“,ä¸¥ç¦ç¼–é€ æˆ–æ¨èä¸å­˜åœ¨çš„å•†å“\"\n      - \"productä¸ºç©ºæˆ–æ— åˆé€‚å•†å“æ—¶,è¯šå®å‘ŠçŸ¥,ä¸å¼ºè¡Œæ¨è\"\n      - \"ä¼˜å…ˆå‚è€ƒsupport_strategy,ç»“åˆé¡¾å®¢éœ€æ±‚åŒ¹é…å•†å“\"\n      - \"ä¸¥ç¦ä½¿ç”¨å¸¸è¯†ã€ç»éªŒæˆ–æ¨ç†è¡¥å……å•†å“ä¿¡æ¯\"\n  </constraints>\n</system>",
                          "presence_penalty": 1.5,
                          "frequency_penalty": 0,
                          "is_show_think_var": null
                      },
                      "isEnable": true,
                      "relation": null,
                      "actionType": "INTEGRATION",
                      "conditions": [],
                      "formConfig": null,
                      "packageName": "integration.llm.LLMAction",
                      "sortCopyIndex": -1
                  },
                  "name": "summary",
                  "type": "LLM",
                  "layout": {
                      "width": 420,
                      "height": 1061,
                      "position": {
                          "x": 2720,
                          "y": 0
                      }
                  },
                  "isEnable": true,
                  "relation": null,
                  "actionType": "INTEGRATION"
              },
              {
                  "id": "d4c6dc28-e453-4e3c-be91-7181381d49a4",
                  "data": {
                      "name": "type",
                      "type": null,
                      "inputs": {
                          "code": "from betteryeah import BetterYeah, Model\nbetter_yeah = BetterYeah()\n\n# å¿…é¡»ä¿è¯èŠ‚ç‚¹ä¸­å­˜åœ¨ä¸€ä¸ªmainå‡½æ•°\n# ä½ çš„ä»£ç åº”è¯¥åœ¨mainå‡½æ•°ä¸­ç¼–å†™\n# mainå‡½æ•°çš„è¿”å›å€¼ä¸ºå½“å‰èŠ‚ç‚¹çš„è¿”å›å€¼\nasync def main():\n    # è·å–å‚æ•°\n    database_id = database_config[\"id\"]\n    \n    # æ„å»ºSQLæŸ¥è¯¢\n    sql = \"SELECT distinct å•†å“å“ç±» FROM åº—é“ºå•†å“ç›®å½• LIMIT 500;\"\n    \n    # æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢\n    res = await better_yeah.database.execute_database(\n        base_id=database_id,\n        executable_sql=sql\n    )\n    \n    # è¿”å›JSONæ ¼å¼\n    return {\n        \"command\": res.data.command,\n        \"rowCount\": res.data.rowCount,\n        \"data\": res.data.data\n    }\n",
                          "desc": "",
                          "version": 1,
                          "language": "python"
                      },
                      "isEnable": true,
                      "relation": null,
                      "actionType": "CODE",
                      "conditions": [],
                      "formConfig": null,
                      "packageName": "",
                      "sortCopyIndex": -1
                  },
                  "name": "type",
                  "type": "CODE",
                  "layout": {
                      "width": 420,
                      "height": 435,
                      "position": {
                          "x": 544,
                          "y": 0
                      }
                  },
                  "isEnable": true,
                  "relation": null,
                  "actionType": "CODE"
              },
              {
                  "id": "5ec94526-e3a7-48b5-a6ad-d22882b4a6be",
                  "data": {
                      "name": "product",
                      "type": null,
                      "inputs": {
                          "code": "from betteryeah import BetterYeah\nimport json\nimport re\n\nbetter_yeah = BetterYeah()\n\ndef extract_product_codes_from_dialogue(dialogue_data):\n    \"\"\"\n    ä»å¯¹è¯ä¸­æå–è´§å·/æ¬¾å·(å­—æ¯+æ•°å­—ç»„åˆ)\n    æ”¯æŒæ ¼å¼: dw2415, ABC123, 845680, M123-456ç­‰\n    \"\"\"\n    codes = []\n    \n    for message in dialogue_data:\n        if not message or not isinstance(message, dict):\n            continue\n        \n        if message.get(\"role\") not in [\"user\", \"assistant\"]:\n            continue\n            \n        content = message.get(\"content\")\n        if not content:\n            continue\n        \n        # æå–æ–‡æœ¬\n        if isinstance(content, str):\n            text = content\n        elif isinstance(content, dict):\n            text = content.get('text', '')\n        else:\n            continue\n        \n        # åŒ¹é…è´§å·æ¨¡å¼(æ”¯æŒä¸­æ–‡ç¯å¢ƒ)\n        matches = re.findall(r'([a-zA-Z0-9][-_a-zA-Z0-9]{2,})', text)\n        \n        for code in matches:\n            # è¿‡æ»¤çº¯å­—æ¯(å¯èƒ½æ˜¯æ™®é€šå•è¯)\n            if not re.search(r'\\d', code):\n                continue\n            # è¿‡æ»¤çº¯æ•°å­—ä¸”é•¿åº¦<4(å¯èƒ½æ˜¯æ•°é‡)\n            if code.isdigit() and len(code) < 4:\n                continue\n            # å»é‡\n            if code not in codes:\n                codes.append(code)\n    \n    return codes\n\nasync def fetch_products_by_codes(database_id, product_codes):\n    \"\"\"\n    æ ¹æ®è´§å·æ¨¡ç³ŠåŒ¹é…å•†å“\n    \"\"\"\n    if not product_codes:\n        return []\n    \n    # æ„å»ºLIKEæŸ¥è¯¢æ¡ä»¶\n    like_conditions = \" OR \".join([f\"å•†å“æ ‡é¢˜ LIKE '%{code}%'\" for code in product_codes])\n    \n    product_sql = f\"\"\"\n    SELECT \n        å•†å“id, å•†å“æ ‡é¢˜, å•†å“é“¾æ¥, å‚æ•°, å•†å“è¯¦æƒ…é¡µè¯†åˆ«ç»“æœ, \n        è½®æ’­å›¾è¯†åˆ«ç»“æœ, å–ç‚¹, è¡¥å……çŸ¥è¯†\n    FROM åº—é“ºå•†å“ç›®å½•\n    WHERE {like_conditions}\n    LIMIT 20\n    \"\"\"\n    \n    try:\n        product_res = await better_yeah.database.execute_database(\n            base_id=database_id,\n            executable_sql=product_sql\n        )\n        \n        if product_res.success and hasattr(product_res.data, 'data'):\n            products = product_res.data.data\n            if products:\n                print(f\"[æ•°æ®] è´§å·åŒ¹é…:{len(products)}ä¸ª\")\n            return products\n        \n    except Exception as e:\n        print(f\"[é”™è¯¯] è´§å·æŸ¥è¯¢å¤±è´¥: {str(e)}\")\n    \n    return []\n\nasync def main():\n    \"\"\"\n    æ•´åˆæ•°æ®åº“å’ŒçŸ¥è¯†åº“æ•°æ®\n    æ”¯æŒ: 1.è´§å·æŸ¥è¯¢(ä¼˜å…ˆ) 2.å“ç±»æ¨è(è¡¥å……)\n    \"\"\"\n    \n    # è·å–å‚æ•°\n    database_id = database_config[\"id\"]\n    category = match.get(\"category\", \"\")\n    \n    all_products = []\n    \n    # ========== 1. è´§å·æŸ¥è¯¢(ä¼˜å…ˆ) ==========\n    product_codes = extract_product_codes_from_dialogue(dialogue)\n    \n    if product_codes:\n        print(f\"[æå–] è´§å·:{len(product_codes)}ä¸ª\")\n        products_by_code = await fetch_products_by_codes(database_id, product_codes)\n        all_products.extend(products_by_code)\n    \n    # ========== 2. å“ç±»æ¨è(è¡¥å……) ==========\n    if category and len(all_products) < 20:\n        limit = 20 - len(all_products)\n        \n        product_sql = f\"\"\"\n        SELECT \n            å•†å“id, å•†å“æ ‡é¢˜, å•†å“é“¾æ¥, å‚æ•°, å•†å“è¯¦æƒ…é¡µè¯†åˆ«ç»“æœ, \n            è½®æ’­å›¾è¯†åˆ«ç»“æœ, å–ç‚¹, è¡¥å……çŸ¥è¯†\n        FROM (\n          SELECT\n            å•†å“id, å•†å“æ ‡é¢˜, å•†å“é“¾æ¥, å‚æ•°, å•†å“è¯¦æƒ…é¡µè¯†åˆ«ç»“æœ, \n            è½®æ’­å›¾è¯†åˆ«ç»“æœ, å–ç‚¹, è¡¥å……çŸ¥è¯†,\n            ROW_NUMBER() OVER (PARTITION BY å•†å“id ORDER BY id) AS rn,\n            CASE WHEN æ˜¯å¦ä¸»æ¨ = 'æ˜¯' THEN 1 ELSE 2 END AS priority\n          FROM åº—é“ºå•†å“ç›®å½•\n          WHERE å•†å“å“ç±» LIKE '%{category}%'\n        ) t\n        WHERE rn = 1\n        ORDER BY priority ASC, RANDOM()\n        LIMIT {limit}\n        \"\"\"\n        \n        try:\n            product_res = await better_yeah.database.execute_database(\n                base_id=database_id,\n                executable_sql=product_sql\n            )\n            \n            if product_res.success and hasattr(product_res.data, 'data'):\n                products = product_res.data.data\n                all_products.extend(products)\n                print(f\"[æ•°æ®] å“ç±»æ¨è:{len(products)}ä¸ª\")\n        \n        except Exception as e:\n            print(f\"[é”™è¯¯] å“ç±»æŸ¥è¯¢å¤±è´¥: {str(e)}\")\n    \n    if not all_products:\n        return []\n    \n    # ========== 3. å»é‡(åŸºäºå•†å“ID) ==========\n    seen_ids = set()\n    unique_products = []\n    for p in all_products:\n        if isinstance(p, dict):\n            item_id = p.get(\"å•†å“id\")\n            if item_id and item_id not in seen_ids:\n                seen_ids.add(item_id)\n                unique_products.append(p)\n    \n    # ========== 4. æ‰¹é‡æŸ¥è¯¢SKU ==========\n    product_ids = [p.get(\"å•†å“id\") for p in unique_products]\n    \n    if product_ids:\n        ids_str = \"','\".join(str(pid) for pid in product_ids)\n        sku_sql = f\"\"\"\n        SELECT å•†å“id, sku, skuå›¾è¯†åˆ«ç»“æœ\n        FROM skuå‚æ•°è¡¨\n        WHERE å•†å“id IN ('{ids_str}')\n        \"\"\"\n        \n        try:\n            sku_res = await better_yeah.database.execute_database(\n                base_id=database_id,\n                executable_sql=sku_sql\n            )\n            \n            if sku_res.success:\n                skus = sku_res.data.data\n            else:\n                skus = []\n        except:\n            skus = []\n    else:\n        skus = []\n    \n    # ========== 5. ç»„è£…æ•°æ® ==========\n    # æŒ‰å•†å“IDåˆ†ç»„SKU\n    sku_map = {}\n    for sku in skus:\n        if not isinstance(sku, dict):\n            continue\n        item_id = sku.get(\"å•†å“id\")\n        if item_id:\n            if item_id not in sku_map:\n                sku_map[item_id] = []\n            sku_map[item_id].append({\n                \"sku\": sku.get(\"sku\", \"\"),\n                \"skuå›¾è¯†åˆ«ç»“æœ\": sku.get(\"skuå›¾è¯†åˆ«ç»“æœ\", \"\")\n            })\n    \n    # ç»„è£…æœ€ç»ˆç»“æœ\n    processed_data = []\n    for product in unique_products:\n        if not isinstance(product, dict):\n            continue\n            \n        item_id = product.get(\"å•†å“id\", \"\")\n        \n        processed_item = {\n            \"å•†å“id\": item_id,\n            \"å•†å“æ ‡é¢˜\": product.get(\"å•†å“æ ‡é¢˜\", \"\"),\n            \"å•†å“é“¾æ¥\": product.get(\"å•†å“é“¾æ¥\", \"\"),\n            \"å‚æ•°\": product.get(\"å‚æ•°\", \"\"),\n            \"å•†å“è¯¦æƒ…é¡µè¯†åˆ«ç»“æœ\": [],\n            \"è½®æ’­å›¾è¯†åˆ«ç»“æœ\": [],\n            \"å–ç‚¹\": product.get(\"å–ç‚¹\", \"\"),\n            \"è¡¥å……çŸ¥è¯†\": product.get(\"è¡¥å……çŸ¥è¯†\", \"\"),\n            \"sku\": sku_map.get(item_id, [])\n        }\n        \n        # å¤„ç†å•†å“è¯¦æƒ…é¡µè¯†åˆ«ç»“æœ - å»æ‰url\n        detail_result = product.get(\"å•†å“è¯¦æƒ…é¡µè¯†åˆ«ç»“æœ\", \"\")\n        if detail_result:\n            try:\n                detail_list = json.loads(detail_result) if isinstance(detail_result, str) else detail_result\n                if isinstance(detail_list, list):\n                    for detail_item in detail_list:\n                        if isinstance(detail_item, dict):\n                            desc_dict = {k: v for k, v in detail_item.items() if k.startswith(\"image_desc\")}\n                            if desc_dict:\n                                processed_item[\"å•†å“è¯¦æƒ…é¡µè¯†åˆ«ç»“æœ\"].append(desc_dict)\n            except:\n                pass\n        \n        # å¤„ç†è½®æ’­å›¾è¯†åˆ«ç»“æœ - å»æ‰url\n        carousel_result = product.get(\"è½®æ’­å›¾è¯†åˆ«ç»“æœ\", \"\")\n        if carousel_result:\n            try:\n                carousel_list = json.loads(carousel_result) if isinstance(carousel_result, str) else carousel_result\n                if isinstance(carousel_list, list):\n                    for carousel_item in carousel_list:\n                        if isinstance(carousel_item, dict):\n                            desc_dict = {k: v for k, v in carousel_item.items() if k.startswith(\"image_desc\")}\n                            if desc_dict:\n                                processed_item[\"è½®æ’­å›¾è¯†åˆ«ç»“æœ\"].append(desc_dict)\n            except:\n                pass\n        \n        processed_data.append(processed_item)\n    \n    print(f\"[å®Œæˆ] è¿”å›å•†å“:{len(processed_data)}ä¸ª\")\n    \n    return processed_data",
                          "desc": "",
                          "version": 1,
                          "language": "python"
                      },
                      "isEnable": true,
                      "relation": null,
                      "actionType": "CODE",
                      "conditions": [],
                      "formConfig": null,
                      "packageName": "",
                      "sortCopyIndex": -1
                  },
                  "name": "product",
                  "type": "CODE",
                  "layout": {
                      "width": 420,
                      "height": 435,
                      "position": {
                          "x": 1632,
                          "y": 0
                      }
                  },
                  "isEnable": true,
                  "relation": null,
                  "actionType": "CODE"
              },
              {
                  "id": "660a1d0d-6940-4463-9791-0e5f89b7a96a",
                  "data": {
                      "name": "behavior",
                      "type": null,
                      "inputs": {
                          "code": "from betteryeah import BetterYeah\nbetter_yeah = BetterYeah()\n\nasync def main():\n    # è·å–database_id\n    database_id = database_config[\"id\"]\n    \n    # æ„å»ºSQLæŸ¥è¯¢\n    sql = f\"SELECT situation, action FROM åœºæ™¯ç­–ç•¥ WHERE äº‹ä»¶äºŒçº§æ ‡ç­¾ = '{event_two}' LIMIT 50\"\n    \n    # æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢\n    res = await better_yeah.database.execute_database(\n        base_id=database_id,\n        executable_sql=sql\n    )\n    \n    # ç›´æ¥è¿”å›dataæ•°ç»„\n    if res.success and res.data and res.data.data:\n        return res.data.data\n    else:\n        return []",
                          "desc": "",
                          "version": 1,
                          "language": "python"
                      },
                      "isEnable": true,
                      "relation": null,
                      "actionType": "CODE",
                      "conditions": [],
                      "formConfig": null,
                      "packageName": "",
                      "sortCopyIndex": -1
                  },
                  "name": "behavior",
                  "type": "CODE",
                  "layout": {
                      "width": 420,
                      "height": 435,
                      "position": {
                          "x": 2176,
                          "y": 0
                      }
                  },
                  "isEnable": true,
                  "relation": null,
                  "actionType": "CODE"
              }
          ]
      },
      "description": "å•†å“æ¨è-v3.0",
      "icon": "ğŸŒ¼",
      "createBy": "å¤•è°·",
      "creatorId": 45000,
      "flowId": "a36b0393cb744b81a90b10c2ed8064a2",
      "id": "a36b0393cb744b81a90b10c2ed8064a2",
      "modifiedAt": "2025-11-28T11:24:31.779543",
      "modifiedBy": "å¤•è°·",
      "isPublic": false,
      "name": "å•†å“æ¨è-v3.0",
      "workspaceId": "531c14d1ece047cbaec22914e1f1364d",
      "versionId": "310db8c1f5d642b98bc3bad505c01fc8",
      "versionStatus": "PUBLISHED",
      "applicationVersion": 3,
      "appGroupId": "f89f3467ca0e4638a28883eabf44610d",
      "appIsExample": false,
      "isEnable": true,
      "isBot": false,
      "copilot_conversation_id": "",
      "copilot_session_id": "",
      "flow_lock": 0,
      "copilot_agent_id": "893949ba623c465c9d2795a780b54c14",
      "env": "TEST",
      "env_var": [],
      "env_app_id": "2609b3b3fec44e348cafefbf8778772d",
      "active_multi_env": true,
      "channel_type": "flow"
  },
  "request_id": "6f1d5f637d2d4a158344c70d4f058493",
  "now_time": 1764300345
}
